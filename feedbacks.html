<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Feedback quotidien</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap"
    rel="stylesheet"
  />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Orbitron', monospace;
      background: #0a0a0a; color: #00ff41; min-height: 100vh; margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
      background-image:
        radial-gradient(circle at 25% 25%, #ff006620 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, #00ff4120 0%, transparent 50%),
        linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      overflow-x: hidden; position: relative;
    }

    /* Scanlines */
    body::after { content: ''; position: fixed; inset: 0; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,65,0.03) 2px, rgba(0,255,65,0.03) 4px); pointer-events: none; z-index: 1000; }

    h1 {
      color: #00ff41; text-shadow: 0 0 10px #00ff41, 0 0 20px #00ff4180, 0 0 40px #00ff4160;
      margin: 1rem 0; font-size: clamp(1.6rem, 5vw, 2.4rem); letter-spacing: 3px; text-align: center; width: 100%; font-weight: 900;
    }
    h1:hover { animation: glitch .3s; }

    .panel {
      background: linear-gradient(135deg, #1a1a1a, #0f0f0f);
      border: 2px solid #00ff41;
      padding: 1.5rem;
      margin-top: 1rem;
      width: 100%;
      max-width: 100%;
      clip-path: polygon(20px 0%, 100% 0%, calc(100% - 20px) 100%, 0% 100%);
      box-shadow: 0 10px 30px rgba(0,255,65,0.2), inset 0 0 20px rgba(0,255,65,0.08);
      animation: slideInUp .6s ease-out;
    }

    .links { margin-bottom: 1.1rem; text-align: center; display: flex; flex-wrap: wrap; gap: 0.8rem; justify-content: center; }
    .links a {
      color: #ffff00; text-decoration: none; font-weight: 700; letter-spacing: 1px; font-size: clamp(0.8rem, 3vw, 1rem);
      text-shadow: 0 0 10px #ffff0080; transition: all .2s ease; word-break: break-word;
      background: linear-gradient(135deg, #1a1a1a, #2a2a2a); border: 1px solid #ffff00; padding: 8px 12px;
      clip-path: polygon(10px 0%, 100% 0%, calc(100% - 10px) 100%, 0% 100%);
    }
    .links a:hover { color: #ffff00; background: linear-gradient(135deg, #ffff0020, #ffff0010); box-shadow: 0 0 15px #ffff00, inset 0 0 15px #ffff0020; transform: translateY(-2px); }

    label { display: block; margin: 1rem 0 0.25rem; color: #ffff00; font-size: clamp(0.85rem, 2.5vw, 0.95rem); text-shadow: 0 0 10px #ffff0080; }

    textarea, input[type="file"] {
      width: 100%; background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 12px; font-size: clamp(0.9rem, 2.5vw, 1rem);
      margin-bottom: 0.8rem; resize: vertical; min-height: 80px; outline: none; transition: all .3s ease;
      clip-path: polygon(10px 0%, 100% 0%, calc(100% - 10px) 100%, 0% 100%);
    }
    textarea { font-family: 'Orbitron', monospace; }
    textarea:focus, input[type="file"]:focus { border-color: #00ff41; box-shadow: 0 0 12px #00ff4140, inset 0 0 12px #00ff4115; background: #151515; }

    button {
      background: linear-gradient(135deg, #1a1a1a, #2a2a2a); color: #ffff00; border: 1px solid #ffff00;
      border-radius: 0; font-size: clamp(0.95rem, 3vw, 1.1rem); padding: 12px 16px; margin: 0.7rem 0; cursor: pointer;
      box-shadow: none; transition: all .2s ease; width: 100%; font-weight: 900; text-transform: uppercase; letter-spacing: 2px;
      clip-path: polygon(10px 0%, 100% 0%, calc(100% - 10px) 100%, 0% 100%);
    }
    button:hover { background: linear-gradient(135deg, #ffff0020, #ffff0010); box-shadow: 0 0 15px #ffff00, inset 0 0 15px #ffff0020; transform: translateY(-2px); color: #ffff00; }

    .feedbacks {
      margin-top: 1.1rem; background: linear-gradient(135deg, #1a1a1a, #0f0f0f);
      border: 2px solid #00ff41; padding: 1rem; max-height: 50vh; overflow-y: auto; width: 100%;
      clip-path: polygon(20px 0%, 100% 0%, calc(100% - 20px) 100%, 0% 100%);
    }

    .entry {
      margin-bottom: 1rem; border-left: 3px solid #ffff00; padding: 0.8rem; background: linear-gradient(135deg, #2a2a2a, #1f1f1f);
      clip-path: polygon(15px 0%, 100% 0%, calc(100% - 15px) 100%, 0% 100%);
      box-shadow: 0 0 20px rgba(255,255,0,0.12);
      position: relative;
    }
    .entry img { max-width: 100%; height: auto; border-radius: 5px; border: 1px solid #00ff41; margin-top: 5px; box-shadow: 0 0 6px #00ff7a; display: block; }

    .datetime { color: #ffff00; font-size: clamp(0.75rem, 2vw, 0.85rem); margin-bottom: 4px; }

    .seeall {
      display: block; margin: 1.1rem auto 0; background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
      border: 1px solid #ffff00; color: #ffff00; padding: 0.5rem 1.4rem; box-shadow: none; font-size: clamp(0.9rem, 2.5vw, 1rem);
      cursor: pointer; transition: all .2s ease; width: auto; min-width: 140px; font-weight: 900; text-transform: uppercase; letter-spacing: 2px;
      clip-path: polygon(10px 0%, 100% 0%, calc(100% - 10px) 100%, 0% 100%);
    }
    .seeall:hover { background: linear-gradient(135deg, #ffff0020, #ffff0010); box-shadow: 0 0 15px #ffff00, inset 0 0 15px #ffff0020; transform: translateY(-2px); }

    ::selection { background: #ff0066; color: #fff; }

    /* Hover action buttons on entries */
    .entry-actions { position: absolute; top: 6px; right: 6px; display: flex; gap: 6px; }
    .entry-actions button {
      width: auto; min-width: unset; padding: 6px 8px; font-size: 0.85rem; letter-spacing: 1px;
      background: linear-gradient(135deg, #1a1a1a, #2a2a2a); border: 1px solid #ffff00; color: #ffff00;
      clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
      opacity: 0; visibility: hidden; pointer-events: none; transform: translateY(-2px) scale(0.98);
      transition: opacity .3s ease, transform .3s ease, visibility 0s linear .3s;
    }
    .entry:hover .entry-actions button { opacity: 1; visibility: visible; pointer-events: auto; transform: translateY(0) scale(1); transition-delay: 0s; }
    .entry-actions button:hover { box-shadow: 0 0 12px #ffff00, inset 0 0 10px #ffff0020; }

    /* Scrollbar styling */
    .feedbacks::-webkit-scrollbar { width: 8px; }
    .feedbacks::-webkit-scrollbar-track { background: rgba(255, 255, 0, 0.1); border-radius: 4px; }
    .feedbacks::-webkit-scrollbar-thumb { background: #ffff00; border-radius: 4px; }
    .feedbacks::-webkit-scrollbar-thumb:hover { background: #ffcc00; }

    /* Media queries */
    @media (min-width: 769px) {
      body { padding: 20px; }
      .panel { padding: 3rem; max-width: 95%; margin: 2rem auto; }
      .feedbacks { max-height: 60vh; padding: 2rem; }
      textarea { min-height: 120px; }
      .links { margin-bottom: 2rem; }
    }

    @media (max-width: 768px) and (min-width: 481px) { .panel { max-width: 90%; } }

    @media (max-width: 480px) {
      body { padding: 12px; }
      .panel { padding: 1rem; margin-top: 0.5rem; max-width: 420px; }
      h1 { margin: 0.5rem 0; letter-spacing: 2px; font-size: 1.6rem; }
      .links { gap: 0.5rem; margin-bottom: 0.8rem; }
      textarea, input[type="file"] { padding: 10px; font-size: 0.95rem; }
      button { padding: 12px; margin: 0.5rem 0; }
      .feedbacks { padding: 0.8rem; max-height: 40vh; }
      .entry { padding: 0.8rem; margin-bottom: 0.8rem; }
      .seeall { padding: 0.5rem 1rem; margin: 0.8rem auto 0; }
    }

    @media (max-width: 320px) {
      body { padding: 8px; }
      .panel { padding: 0.8rem; }
      .links a { font-size: 0.8rem; }
      textarea { min-height: 60px; }
      .feedbacks { max-height: 35vh; }
    }

    /* Ensure long elements wrap */
    * { max-width: 100%; overflow-wrap: break-word; }
  </style>

  <!-- Supabase client, utils, and auth helpers -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabaseClient.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <!-- JSZip for downloads -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    // Utilise le client Supabase existant (window.sb) et AuthHelpers
    const IMGBB_API_KEY = "78e05cd74f26e3e31a04ba7366739c98";
    let feedbacks = [];
    let showingAll = false;
    let currentSession = null;

    async function loadFeedbacks(limit = 3) {
      if (!window.sb || !currentSession) return;
      let query = window.sb
        .from("Feedbaaack")
        .select("id, content, created_at")
        .eq("user_id", currentSession.user.id)
        .order("created_at", { ascending: false });
      if (!showingAll) query = query.limit(limit);
      const { data, error } = await query;
      if (error) {
        console.error("Erreur chargement feedback:", error);
        alert("Erreur chargement feedback : " + error.message);
        return;
      }
      feedbacks = data || [];
      render();
      const seeAllBtn = document.getElementById("seeall");
      if (seeAllBtn) {
        seeAllBtn.style.display = feedbacks.length === limit && !showingAll ? "block" : "none";
      }
    }

    function render() {
      const box = document.getElementById("feedbacks");
      if (!currentSession) {
        box.innerHTML = "<div style='color:#ff4ecd;'>Connecte-toi pour voir et enregistrer tes feedbacks.</div>";
        return;
      }
      if (!feedbacks.length) {
        box.innerHTML = "<div style='color:#ff4ecd;'>Aucun feedback enregistr√©.</div>";
        return;
      }
      box.innerHTML = feedbacks
        .map(
          (fb) => `
        <div class="entry" data-id="${fb.id}">
          <div class="entry-actions">
            <button type="button" class="edit" title="Modifier">‚úèÔ∏è</button>
            <button type="button" class="download" title="T√©l√©charger">‚¨áÔ∏è</button>
            <button type="button" class="delete" title="Supprimer">üóëÔ∏è</button>
          </div>
          <div class="datetime">${new Date(fb.created_at).toLocaleString()}</div>
          ${
            (window.Utils ? Utils.isImageUrl(fb.content) : (typeof fb.content === 'string' && fb.content.match(/^https?:\/\/.+\.(jpg|jpeg|png|webp)$/i)))
              ? `<img src="${fb.content}" alt="Feedback manuscrit" loading="lazy">`
              : `<div class="text">${fb.content.replace(/\n/g, "<br>")}</div>`
          }
        </div>
      `
        )
        .join("");

      // Bind action buttons
      box.querySelectorAll('.entry .edit').forEach(btn => btn.addEventListener('click', (e) => {
        const entry = e.currentTarget.closest('.entry');
        const id = entry?.dataset?.id;
        if (!id) return;
        openEditInline(entry, id);
      }));
      box.querySelectorAll('.entry .download').forEach(btn => btn.addEventListener('click', async (e) => {
        const entry = e.currentTarget.closest('.entry');
        const id = entry?.dataset?.id;
        if (!id) return;
        const fb = feedbacks.find(f => String(f.id) === String(id));
        if (!fb) return;
        await downloadFeedback(fb);
      }));
      box.querySelectorAll('.entry .delete').forEach(btn => btn.addEventListener('click', async (e) => {
        const entry = e.currentTarget.closest('.entry');
        const id = entry?.dataset?.id;
        if (!id) return;
        await deleteFeedback(id);
      }));
    }

    function isImage(urlOrText) {
      return (window.Utils ? Utils.isImageUrl(urlOrText) : (typeof urlOrText === 'string' && /^https?:\/\/.+\.(jpg|jpeg|png|webp)$/i.test(urlOrText)));
    }

    function openEditInline(entryEl, id) {
      const fb = feedbacks.find(f => String(f.id) === String(id));
      if (!fb) return;
      const currentIsImage = isImage(fb.content);
      const currentText = currentIsImage ? '' : (fb.content || '');
      const editor = document.createElement('div');
      editor.innerHTML = `
        <div class="editor" style="margin-top:8px; border-top:1px dashed #333; padding-top:8px;">
          <label style="color:#ffff00;">Modifier le texte :</label>
          <textarea rows="3" style="width:100%; background:#1a1a1a; color:#fff; border:1px solid #333; padding:10px; clip-path: polygon(10px 0%, 100% 0%, calc(100% - 10px) 100%, 0% 100%);">${currentText.replace(/</g,'&lt;')}</textarea>
          <label style="color:#ffff00;">Ou remplacer par une image :</label>
          <input type="file" accept="image/png, image/jpeg, image/webp" />
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button type="button" class="save" style="width:auto; min-width:120px;">üíæ Enregistrer</button>
            <button type="button" class="cancel" style="width:auto;">Annuler</button>
          </div>
        </div>`;
      const existingEditor = entryEl.querySelector('.editor');
      if (existingEditor) existingEditor.remove();
      entryEl.appendChild(editor.firstElementChild);

      const textarea = entryEl.querySelector('.editor textarea');
      const fileInput = entryEl.querySelector('.editor input[type="file"]');
      const saveBtn = entryEl.querySelector('.editor .save');
      const cancelBtn = entryEl.querySelector('.editor .cancel');

      cancelBtn.onclick = () => { entryEl.querySelector('.editor')?.remove(); };

      saveBtn.onclick = async () => {
        try {
          let newContent = textarea.value.trim();
          const file = fileInput.files[0];
          if (file) {
            if (!window.Utils || typeof Utils.uploadToImgBB !== 'function') {
              alert('Upload indisponible. Utils.uploadToImgBB manquant.');
              return;
            }
            newContent = await Utils.uploadToImgBB(file, IMGBB_API_KEY);
          }
          if (!newContent) { alert('Le feedback ne peut pas √™tre vide.'); return; }
          const { error } = await window.sb
            .from('Feedbaaack')
            .update({ content: newContent })
            .eq('user_id', currentSession.user.id)
            .eq('id', id);
          if (error) throw error;
          await loadFeedbacks(showingAll ? 99 : 3);
        } catch (err) {
          console.error('[EDIT] Erreur update:', err);
          alert('Erreur mise √† jour: ' + (err?.message || err));
        }
      };
    }

    async function downloadFeedback(fb) {
      try {
        if (!isImage(fb.content)) {
          const blob = new Blob([fb.content || ''], { type: 'text/plain;charset=utf-8' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `feedback_${new Date(fb.created_at).toISOString().slice(0,19).replace(/[-:T]/g,'')}.txt`;
          document.body.appendChild(a); a.click(); a.remove();
          return;
        }
        if (!window.JSZip) { alert('JSZip non charg√©.'); return; }
        const zip = new JSZip();
        const txt = `Image feedback URL:\n${fb.content}`;
        zip.file('feedback.txt', txt);
        const res = await fetch(fb.content, { mode: 'cors' });
        const imgBlob = await res.blob();
        const ext = (fb.content.match(/\.(jpg|jpeg|png|webp)(?:\?|#|$)/i) || [,'jpg'])[1].toLowerCase();
        zip.file(`image.${ext}`, imgBlob);
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(zipBlob);
        a.download = `feedback_${new Date(fb.created_at).toISOString().slice(0,19).replace(/[-:T]/g,'')}.zip`;
        document.body.appendChild(a); a.click(); a.remove();
      } catch (err) {
        console.error('[DOWNLOAD] Erreur:', err);
        alert('Erreur t√©l√©chargement: ' + (err?.message || err));
      }
    }

    async function deleteFeedback(id) {
      try {
        if (!confirm('Supprimer ce feedback ?')) return;
        const { error } = await window.sb
          .from('Feedbaaack')
          .delete()
          .eq('user_id', currentSession.user.id)
          .eq('id', id);
        if (error) throw error;
        await loadFeedbacks(showingAll ? 99 : 3);
      } catch (err) {
        console.error('[DELETE] Erreur:', err);
        alert('Erreur suppression: ' + (err?.message || err));
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // Init nav + session
      if (window.AuthHelpers && typeof window.AuthHelpers.initAuthNav === "function") {
        await window.AuthHelpers.initAuthNav();
      }
      currentSession = window.AuthHelpers ? await window.AuthHelpers.getSession() : null;

      // React to auth changes
      if (window.sb && window.sb.auth && typeof window.sb.auth.onAuthStateChange === "function") {
        window.sb.auth.onAuthStateChange((_event, session) => {
          currentSession = session;
          // Toggle form availability
          const disabled = !currentSession;
          const form = document.getElementById("form");
          if (form) {
            [...form.elements].forEach(el => (el.disabled = disabled));
          }
          showingAll = false;
          loadFeedbacks();
        });
      }

      // Disable form if not logged in on first load
      const form = document.getElementById("form");
      if (form && !currentSession) {
        [...form.elements].forEach(el => (el.disabled = true));
      }

      // Submit handler
      if (form) {
        form.onsubmit = async (e) => {
          e.preventDefault();
          if (!currentSession) {
            alert("Tu dois √™tre connect√© pour enregistrer un feedback.");
            window.location.href = 'login.html';
            return;
          }
          const text = document.getElementById("content").value.trim();
          const imageInput = document.getElementById("img").files[0];
          let content = text;
          if (imageInput) {
            try {
              content = window.Utils ? await Utils.uploadToImgBB(imageInput, IMGBB_API_KEY) : content;
            } catch (err) {
              alert("Erreur upload image : " + err.message);
              return;
            }
          } else if (!text) {
            alert("Ajoute un texte ou choisis une image !");
            return;
          }
          const { error } = await window.sb
            .from("Feedbaaack")
            .insert([{ content, user_id: currentSession.user.id }]);
          if (error) {
            console.error("Erreur ajout feedback :", error);
            alert("Erreur ajout feedback : " + error.message);
            return;
          }
          form.reset();
          showingAll = false;
          loadFeedbacks();
        };
      }

      const seeAllBtn = document.getElementById("seeall");
      if (seeAllBtn) {
        seeAllBtn.onclick = () => {
          showingAll = true;
          loadFeedbacks(99);
        };
      }

      loadFeedbacks();
    });
  </script>
</head>
<body>
  <h1>üìä Feedback</h1>
  <div class="panel">
    <div class="links">
      <a href="https://tahlasandale.github.io/MaGazette/SimpleTabHTML.html" target="_blank">üìù Pad</a>
      <a href="https://chatgpt.com" target="_blank">üé§ ChatGPT</a>
    </div>
    <form id="form" autocomplete="off">
      <label for="content">Ton feedback</label>
      <textarea id="content" rows="3" placeholder="Comment s‚Äôest pass√©e ta journ√©e ?"></textarea>
      <label for="img">Ou ajoute une image :</label>
      <input type="file" id="img" accept="image/png, image/jpeg, image/webp" />
      <button type="submit">üíæ Enregistrer le feedback</button>
    </form>
    <div class="feedbacks" id="feedbacks"></div>
    <button class="seeall" id="seeall" style="display: none">Voir tout</button>
  </div>
</body>
</html>

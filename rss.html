<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Actus Tech â€” Scroll Infini + Share + Images</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #000000;
      --muted: #555555;
      --border: #000000;
    }
    html, body { height: 100%; margin: 0; padding: 0; overflow-x: hidden; }
    body { margin: 0; padding: 0; background: var(--bg); color: var(--fg); font-family: "Courier New", Courier, monospace; line-height: 1.5; }
    .container { max-width: 960px; margin: 0 auto; padding: 0 12px; }

    h1 { font-size: 28px; font-weight: 700; margin: 24px 0 16px 0; border-bottom: 2px dotted var(--border); padding-bottom: 6px; }
    .sub { margin: 0 0 24px 0; font-size: 14px; color: var(--muted); }

    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 18px; border: 1px solid var(--border); padding: 10px; border-radius: 2px; position: sticky; top: 0; background: var(--bg); z-index: 100; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .controls label { font-size: 14px; }
    button, select { border: 1px solid var(--border); background: var(--bg); color: var(--fg); padding: 8px 10px; border-radius: 2px; font-family: inherit; font-size: 14px; cursor: pointer; }
    button:hover { filter: invert(100%); }
    select:hover { background: #f5f5f5; }

    .news { border: 1px solid var(--border); padding: 12px; margin-bottom: 10px; border-radius: 2px; background: var(--bg); opacity: 0; transform: translateY(20px); transition: all 0.3s ease; display: flex; flex-direction: column; }
    .news.visible { opacity: 1; transform: translateY(0); }
    .news h2 { font-size: 16px; margin: 0 0 6px 0; }
    .news a { color: var(--fg); text-decoration: underline; text-underline-offset: 2px; }
    .news a:hover { background: #000; color: #fff; }
    .meta { font-size: 12px; color: var(--muted); margin-bottom: 6px; }

    .news img { max-width: 100%; height: auto; border-radius: 4px; margin-bottom: 8px; object-fit: cover; }

    @keyframes blink { 50% { opacity: 0; } }

    footer { text-align: center; font-size: 14px; padding: 40px 0; }

    /* Modal styles */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal { background: var(--bg); color: var(--fg); border: 1px solid var(--border); border-radius: 4px; width: min(480px, 92vw); padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal header { font-weight: 700; margin-bottom: 10px; border-bottom: 1px dotted var(--border); padding-bottom: 6px; }
    .modal .row { display: flex; flex-direction: column; gap: 6px; margin: 10px 0; }
    .modal input { border: 1px solid var(--border); background: var(--bg); color: var(--fg); padding: 8px; font-family: inherit; }
    .modal .actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 14px; }

    @media(max-width: 600px) {
      h1 { font-size: 22px; margin-top: 12px; }
      .controls { flex-direction: column; align-items: flex-start; }
      .news h2 { font-size: 14px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabaseClient.js"></script>
</head>
<body>
  <div class="container" id="container">
    <header>
      <h1>ðŸ“° Actus Tech <span class="cursor"></span></h1>
      <p class="sub">Scroll infini continu avec partage natif et images intÃ©grÃ©es de chaque flux.</p>
    </header>

    <div class="controls" id="controls">
      <button id="refreshBtn"> RafraÃ®chir</button>
      <label for="filter">Filtre :</label>
      <select id="filter">
        <option value="all">Toutes les sources</option>
        <option value="www.frandroid.com">FrAndroid</option>
        <option value="korben.info">Korben</option>
        <option value="raspberrytips.fr">RaspberryTips</option>
        <option value="www.gamekult.com">Gamekult</option>
        <option value="www.journaldugeek.com">Le Journal du Geek</option>
        <option value="www.actuia.com">Actuia Hardware and Co</option>
        <option value="web.developpez.com">DÃ©veloppez.com</option>
      </select>
      <button id="addFeedBtn" title="Ajouter un flux">ï¼‹</button>
    </div>

    <div id="news-container"></div>

    <!-- Add Feed Modal -->
    <div id="addFeedBackdrop" class="modal-backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="addFeedTitle">
        <header id="addFeedTitle">Ajouter un flux RSS</header>
        <div class="row">
          <label for="feedUrl">URL du flux</label>
          <input id="feedUrl" type="url" placeholder="https://exemple.com/feed" required />
        </div>
        <div class="row">
          <label for="feedName">Nom (optionnel)</label>
          <input id="feedName" type="text" placeholder="Nom du flux" />
        </div>
        <div class="actions">
          <button id="cancelAddFeed">Annuler</button>
          <button id="confirmAddFeed">Ajouter</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // FEEDS dynamiques via Supabase `user_feeds`
    let FEEDS = [];
    let allFeeds = [];
    let articlesFlat = [];
    let loadedCount = 0;
    const BATCH_SIZE = 10;
    const container = document.getElementById('news-container');

    async function loadUserFeeds() {
      if (!window.sb) {
        console.error('Supabase non initialisÃ©.');
        return [];
      }
      const { data: { user } } = await window.sb.auth.getUser();
      if (!user) {
        alert('Veuillez vous connecter pour charger vos flux RSS personnalisÃ©s.');
        return [];
      }
      const { data, error } = await window.sb
        .from('user_feeds')
        .select('feed_url, feed_name')
        .eq('user_id', user.id);
      if (error) {
        console.error('Erreur chargement flux :', error);
        return [];
      }
      return (data || [])
        .filter(r => !!r.feed_url)
        .map(r => ({ url: r.feed_url, name: r.feed_name || null }));
    }

    async function getRSS(url) {
      const proxy = 'https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(url);
      const res = await fetch(proxy);
      const data = await res.json();
      return (data.items || []).map(item => ({
        title: item.title || 'Sans titre',
        link: item.link || '#',
        description: (item.content || item.description || '').replace(/<[^>]+>/g, '').trim(),
        date: item.pubDate || '',
        source: new URL(url).hostname,
        image: (item.enclosure && item.enclosure.link) || null
      }));
    }

    function refreshFilterOptions(sources) {
      const select = document.getElementById('filter');
      if (!select) return;
      const current = select.value;
      const opts = ['<option value="all">Toutes les sources</option>']
        .concat(Array.from(new Set(sources)).map(src => `<option value="${src}">${src}</option>`));
      select.innerHTML = opts.join('');
      // Try to restore selection if still present, else default to 'all'
      const stillExists = sources.includes(current);
      select.value = stillExists ? current : 'all';
    }

    async function loadNews() {
      container.innerHTML = '';
      allFeeds = [];

      FEEDS = await loadUserFeeds();
      if (!FEEDS.length) {
        // Clean up UI and show empty state with CTA
        const emptyHtml = `
          <div class="news visible">
            <h2>Aucun flux enregistrÃ©</h2>
            <p>Ajoutez vos sources RSS pour commencer Ã  voir des articles ici.</p>
            <button id="ctaAddFeed">Ajouter un flux</button>
          </div>`;
        container.innerHTML = emptyHtml;
        const cta = document.getElementById('ctaAddFeed');
        if (cta) cta.addEventListener('click', openAddFeedModal);
        // Filter dropdown must be empty when no sources exist
        const select = document.getElementById('filter');
        if (select) {
          select.innerHTML = '';
        }
        return;
      }

      // Build filter options from DB names (or hostname fallback)
      const sourceNames = [];
      for (const feed of FEEDS) {
        const url = feed.url;
        const hostname = (() => { try { return new URL(url).hostname; } catch { return url; } })();
        const sourceName = feed.name || hostname;
        if (!sourceNames.includes(sourceName)) sourceNames.push(sourceName);
      }
      refreshFilterOptions(sourceNames);

      for (const feed of FEEDS) {
        const url = feed.url;
        const hostname = (() => { try { return new URL(url).hostname; } catch { return url; } })();
        const sourceName = feed.name || hostname;
        try {
          const articles = await getRSS(url);
          allFeeds.push({ source: sourceName, articles });
        } catch {
          allFeeds.push({ source: sourceName, articles: [] });
        }
      }

      articlesFlat = allFeeds.flatMap(f => f.articles);
      const currentFilter = (document.getElementById('filter')?.value) || 'all';
      if (currentFilter === 'all') {
        // MÃ©lange alÃ©atoire pour le mode "Toutes les sources"
        shuffle(articlesFlat);
      } else {
        // Tri par date pour une source spÃ©cifique
        articlesFlat.sort((a,b) => new Date(b.date) - new Date(a.date));
      }
      loadedCount = 0;
      loadMoreArticles();
    }

    function createShareButton(article) {
      const btn = document.createElement('button');
      btn.className = 'share-button';
      btn.textContent = 'Partager';
      btn.onclick = async () => {
        if (navigator.share) {
          try { await navigator.share({ title: article.title, text: article.description, url: article.link }); } catch(e) {}
        } else { alert('Partage natif non supportÃ© sur ce navigateur.'); }
      };
      return btn;
    }

    function loadMoreArticles() {
      const nextBatch = articlesFlat.slice(loadedCount, loadedCount + BATCH_SIZE);
      nextBatch.forEach(article => {
        const div = document.createElement('div');
        div.className = 'news';
        const imgHTML = article.image ? `<img src="${article.image}" alt="${article.title}">` : '';
        div.innerHTML = `${imgHTML}<h2><a href="${article.link}" target="_blank">${article.title}</a></h2><div class="meta">ðŸ“… ${article.date} â€” ${article.source}</div><p>${article.description}</p>`;
        div.appendChild(createShareButton(article));
        container.appendChild(div);
        requestAnimationFrame(() => div.classList.add('visible'));
      });
      loadedCount += nextBatch.length;

      if (loadedCount < articlesFlat.length) { setTimeout(loadMoreArticles, 500); }
      else { articlesFlat = [...articlesFlat, ...articlesFlat]; setTimeout(loadMoreArticles, 500); }
    }

    // Randomize helper (Fisher-Yates)
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    document.getElementById('refreshBtn').addEventListener('click', loadNews);
    document.getElementById('filter').addEventListener('change', () => {
      const filter = document.getElementById('filter').value;
      if (filter === 'all') {
        articlesFlat = allFeeds.flatMap(f => f.articles);
        shuffle(articlesFlat);
      } else {
        articlesFlat = allFeeds.filter(f => f.source === filter).flatMap(f => f.articles);
        articlesFlat.sort((a,b) => new Date(b.date) - new Date(a.date));
      }
      loadedCount = 0;
      container.innerHTML = '';
      loadMoreArticles();
    });

    // Modal logic
    const addFeedBackdrop = document.getElementById('addFeedBackdrop');
    const addFeedBtn = document.getElementById('addFeedBtn');
    const cancelAddFeed = document.getElementById('cancelAddFeed');
    const confirmAddFeed = document.getElementById('confirmAddFeed');
    const inputFeedUrl = document.getElementById('feedUrl');
    const inputFeedName = document.getElementById('feedName');

    function openAddFeedModal() {
      if (addFeedBackdrop) {
        addFeedBackdrop.style.display = 'flex';
        setTimeout(() => inputFeedUrl && inputFeedUrl.focus(), 0);
      }
    }
    function closeAddFeedModal() {
      if (addFeedBackdrop) addFeedBackdrop.style.display = 'none';
      if (inputFeedUrl) inputFeedUrl.value = '';
      if (inputFeedName) inputFeedName.value = '';
    }
    if (addFeedBtn) addFeedBtn.addEventListener('click', openAddFeedModal);
    if (cancelAddFeed) cancelAddFeed.addEventListener('click', closeAddFeedModal);
    if (addFeedBackdrop) addFeedBackdrop.addEventListener('click', (e) => {
      if (e.target === addFeedBackdrop) closeAddFeedModal();
    });
    if (confirmAddFeed) confirmAddFeed.addEventListener('click', async () => {
      const url = (inputFeedUrl?.value || '').trim();
      const name = (inputFeedName?.value || '').trim();
      if (!url) return alert('Veuillez saisir une URL de flux valide');
      await addFeed(url, name);
      closeAddFeedModal();
    });

    // Optionnel: ajout d'un flux
    async function addFeed(url, name) {
      if (!window.sb) return alert('Supabase non initialisÃ©');
      const { data: { user } } = await window.sb.auth.getUser();
      if (!user) return alert('Veuillez vous connecter');
      const { error } = await window.sb
        .from('user_feeds')
        .insert({ user_id: user.id, feed_url: url, feed_name: name });
      if (error) { console.error('Erreur ajout flux :', error); return alert('Erreur lors de l\'ajout du flux'); }
      await loadNews();
    }

    loadNews();
  </script>

</body>
</html>
